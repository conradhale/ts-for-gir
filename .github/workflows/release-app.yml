# Workflow to automatically publish app packages to npm on new releases
name: Release App

on:
  release:
    types: [published]
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to use for commit message'
        required: false
        default: 'manual'

jobs:
  publish-app:
    name: Publish App to NPM
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
    
    # This also setups a .npmrc file to publish to npm
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        registry-url: 'https://registry.npmjs.org'
          
    - name: Install yarn dependencies (CLI workspace only)
      run: yarn workspaces focus @ts-for-gir/cli
      
    - name: Build app
      run: yarn build:app
        
    - name: Publish app packages to npm
      run: yarn publish:app
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        
    - name: Summary
      run: |
        echo "âœ… App packages successfully published to npm for release ${{ github.event.release.tag_name || github.event.inputs.release_tag || 'unknown' }}"
        echo "Published packages: @ts-for-gir/* and @gi.ts/*"
