---
description: Use this rule whenever you work on GLib.Variant (GVariant) TypeScript typing/inference
alwaysApply: false
---
## Expected Semantics (Acceptance Contract)
Model these behaviors in `glib-2.0.d.ts` using the existing `$ParseShallowVariant`, `$ParseDeepVariant`, `$ParseRecursiveVariant` utilities.

- Scalars
  - `'b'` → boolean; `'s' | 'o' | 'g'` → string; numeric (`'n' | 'q' | 't' | 'd' | 'u' | 'i' | 'x' | 'y'`) → number; `'h' | '?'` → unknown; `'v'` → Variant (for deep) or any (for recursive).

- Byte array
  - `'ay'` → `Uint8Array` for all unpacking methods.
  - Constructing `'ay'` from string is 0-terminated; from `Uint8Array` is not (see upstream test).

- Arrays
  - `unpack()` → `Variant[]` (elements preserved as `Variant`).
  - `deepUnpack()` → native arrays for base element types (e.g., `'as'` → `string[]`).
  - `recursiveUnpack()` → fully native arrays (all descendants unpacked).

- Tuples/structs `(…)`
  - `unpack()` → array of `Variant` elements.
  - `deepUnpack()` → array of native values; positions with `'v'` remain `Variant`.
  - `recursiveUnpack()` → fully native values.
  - Example: `'(sogvau)'` deep → `[string, string, string, Variant, number[]]`.

- Dictionaries `a{kv}`
  - For `a{sv}`:
    - `unpack()` → `{ [key: string]: Variant }`
    - `deepUnpack()` → `{ [key: string]: Variant }`
    - `recursiveUnpack()` → `{ [key: string]: any }`
  - For uniform dicts (e.g., `a{ss}`): `deepUnpack()` → `{ [key: string]: string }`.

- Maybe `mT`
  - Result may be `null` or the corresponding unpacked form of `T` per method.

---

## Editing Guidelines
- Scope changes to GVariant typing logic; keep utilities readable and explicit.
- Prefer `unknown` over `any`; use precise types where feasible.
- Preserve overload order so `ReturnType<…>` resolves precisely (see `deepUnpack`/`deep_unpack`).
- Follow (mdc:.cursor/rules/clean-code.mdc) and (mdc:.cursor/rules/git-commit-best-practices.mdc).
- Use `.ts` imports consistently in examples/tests.

## Acceptance Criteria
- `yarn workspace @ts-for-gir-test/language-server-validation run test` passes deterministically.
- `yarn workspace @ts-for-gir-example/glib-2-variant run check` passes.
- Behavior matches upstream expectations from `gjs/installed-tests/js/testGLib.js` and linked docs.
- No guardrail violations; any necessary test edits include rationale referencing specs.

## File Map
- Template to edit: `packages/templates/templates/glib-2.0.d.ts`
- Upstream reference: `gjs/installed-tests/js/testGLib.js`
- Example app: `examples/glib-2-variant/main.ts`
- Language Server tests: `tests/language-server-validation/src/gvariant-validation.test.ts`