# Yarn Workspace Structure and Package Organization

This guide covers the ts-for-gir project's yarn workspace structure, package organization, and development workflow.

## Workspace Structure

### Root Level
```
ts-for-gir/
├── packages/           # Core application packages
├── examples/           # Example applications and packages
├── tests/             # Test packages and configurations
├── types/             # Generated type definitions (git submodule)
├── girs/              # GIR source files
├── gjs/               # GJS runtime source (git submodule)
└── vala-girs/         # Vala-generated GIR files
```

### Core Packages (`packages/`)
- **`@ts-for-gir/cli`**: Command-line interface and main application
- **`@ts-for-gir/lib`**: Core library and utilities
- **`@ts-for-gir/parser`**: GIR XML parsing and processing
- **`@ts-for-gir/generator-base`**: Base generator framework
- **`@ts-for-gir/generator-typescript`**: TypeScript type generator
- **`@ts-for-gir/generator-html-doc`**: HTML documentation generator
- **`@ts-for-gir/generator-json`**: JSON output generator
- **`@ts-for-gir/templates`**: EJS templates for type generation
- **`@ts-for-gir/reporter`**: Error reporting and analysis
- **`@gi.ts/parser`**: GIR parser for gi.ts module generation

### Example Packages (`examples/`)
- **`@ts-for-gir-example/*`**: Example applications demonstrating generated types
- **GTK examples**: Hello world, calculator, browser, editor
- **GLib examples**: Spawn commands, variants, types
- **GIO examples**: File operations, async operations, DBus
- **Cairo examples**: Drawing and graphics

### Test Packages (`tests/`)
- **`@ts-for-gir-test/*`**: Test configurations and validation
- **Language server tests**: TypeScript language server integration
- **Type validation tests**: Generated type correctness
- **Local type tests**: Development workflow validation

## Package Management

### Workspace Commands
```bash
# List all workspaces
yarn workspaces list

# Run command in specific workspace
yarn workspace @ts-for-gir/cli run build

# Run command in all workspaces
yarn workspaces foreach run build

# Run command in filtered workspaces
yarn workspaces foreach --include '@ts-for-gir/*' run check
```

### Dependency Management
```bash
# Add dependency to specific workspace
yarn workspace @ts-for-gir/cli add lodash

# Add dev dependency to specific workspace
yarn workspace @ts-for-gir/cli add -D @types/lodash

# Add workspace dependency
yarn workspace @ts-for-gir/cli add @ts-for-gir/lib@workspace:^
```

## Development Workflow

### Package Development
1. **Make changes** in source packages
2. **Test locally** with workspace dependencies
3. **Build packages** if needed
4. **Run tests** to validate changes
5. **Commit changes** following git best practices

### Type Generation Workflow
1. **Update GIR files**: `yarn copy:girs`
2. **Generate types**: `yarn ts-for-gir-dev generate [modules]`
3. **Validate types**: `yarn check:types`
4. **Test examples**: `yarn test:examples`
5. **Commit types**: Update types submodule

## Build and Test Commands

### Core Commands
```bash
# Build all examples
yarn build:examples

# Build all types
yarn build:types

# Build everything
yarn build

# Check linting
yarn check:lint

# Check examples
yarn check:examples

# Check types
yarn check:types

# Check everything
yarn check
```

### Testing Commands
```bash
# Test types
yarn test:types

# Test examples
yarn test:examples

# Test all
yarn test

# Test specific workspace
yarn workspace @ts-for-gir/cli run test
```

## Package Configuration

### Package.json Structure
```json
{
  "name": "@ts-for-gir/cli",
  "version": "4.0.0-beta.26",
  "type": "module",
  "main": "src/index.ts",
  "module": "src/index.ts",
  "exports": {
    ".": "./src/index.ts"
  },
  "bin": {
    "ts-for-gir": "bin/ts-for-gir.js",
    "ts-for-gir-dev": "bin/ts-for-gir-dev.js"
  }
}
```

### Workspace Dependencies
```json
{
  "devDependencies": {
    "@ts-for-gir/lib": "workspace:^",
    "@ts-for-gir/parser": "workspace:^"
  }
}
```

## Type Generation

### Type Generation Process
- **GIR files**: Source GIR XML files in `girs/` directory
- **Generator**: TypeScript generator in `@ts-for-gir/generator-typescript`
- **Templates**: EJS templates in `@ts-for-gir/templates`
- **Output**: Generated types in `types/` directory (git submodule)

### Type Generation Commands
```bash
# Generate specific module
yarn ts-for-gir-dev generate Gtk-4.0

# Generate multiple modules
yarn ts-for-gir-dev generate Gtk-4.0 Gio-2.0

# Generate all modules
yarn ts-for-gir-dev generate --all

# Generate with custom config
yarn ts-for-gir-dev generate --configName=.ts-for-gir.custom.rc.js
```

### Type Output Locations
- **`/types/*` (Git submodule)**: Official published types, may have cached/different results
- **Custom output dirs**: Fresh generation, immediately reflects template/override changes
- **Testing approach**: Use `--outdir=./test-types-*` for development and testing
- **Template changes**: Require regeneration to take effect (`yarn ts-for-gir-dev generate`)

### Advanced Variants Feature
- Controlled by `noAdvancedVariants: false` flag
- Generates additional type variants for better TypeScript inference
- Increases bundle size but improves developer experience
- Can be disabled for production builds

## Example Development

### Example Package Structure
```
examples/gtk-4-hello/
├── package.json       # Package configuration
├── src/               # Source code
├── tsconfig.json      # TypeScript configuration
└── README.md          # Documentation
```

### Example Development Workflow
1. **Create example**: Use existing examples as templates
2. **Add dependencies**: Include generated type packages
3. **Write code**: Use generated types in example code
4. **Test locally**: Run example to validate types
5. **Update types**: Regenerate types if needed

## Testing and Validation

### Test Package Structure
```
tests/types-locally/
├── package.json       # Test configuration
├── src/               # Test source code
├── tsconfig.json      # TypeScript configuration
└── README.md          # Test documentation
```

### Test Workflow
1. **Setup test environment**: Install test dependencies
2. **Run tests**: Execute test commands
3. **Validate output**: Check test results
4. **Debug issues**: Fix failing tests
5. **Update tests**: Maintain test coverage

## Publishing

### Package Publishing
```bash
# Publish application packages
yarn publish:app

# Publish type packages
yarn publish:types

# Publish everything
yarn publish
```

### Publishing Workflow
1. **Build packages**: Ensure all packages are built
2. **Run tests**: Validate package functionality
3. **Update versions**: Bump package versions
4. **Publish packages**: Release to npm registry
5. **Update types**: Commit type submodule changes

## Troubleshooting

### Common Issues
1. **Workspace dependency issues**: Check workspace references
2. **Build failures**: Verify package dependencies
3. **Type generation errors**: Check GIR file validity
4. **Test failures**: Validate test configurations

### Debug Commands
```bash
# Check workspace status
yarn workspaces list

# Verify dependencies
yarn install

# Check package builds
yarn workspace @ts-for-gir/cli run build

# Validate types
yarn check:types
```

## Best Practices

1. **Use workspace dependencies**: Leverage yarn workspace features
2. **Maintain consistency**: Keep package versions aligned
3. **Test thoroughly**: Validate changes across all affected packages
4. **Document changes**: Update documentation for significant changes
5. **Follow conventions**: Maintain consistent package structure and naming
- `yarn build:examples` - Build all examples for GJS execution
- `yarn copy:girs` - Copy system GIR files
- `yarn test` - Run full test suite
- `yarn test:tests` - Quick local testing
- `yarn check` - Type checking across all packages